<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLUX HUB | Ultimate Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg: #050608; 
            --card: rgba(18, 20, 25, 0.7); 
            --border: rgba(255, 255, 255, 0.08); 
            --accent: #3b82f6; 
            --accent-glow: rgba(59, 130, 246, 0.3);
        }

        /* Темы */
        [data-theme="violet"] {
            --bg: #0a050f;
            --accent: #a855f7;
            --accent-glow: rgba(168, 85, 247, 0.3);
        }
        [data-theme="emerald"] {
            --bg: #050f0a;
            --accent: #10b981;
            --accent-glow: rgba(16, 185, 129, 0.3);
        }

        body { 
            background: var(--bg); 
            color: #fff; 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow: hidden; 
            transition: background 0.5s ease;
        }

        /* Анимированный фон */
        .bg-glow {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% -20%, var(--accent-glow), transparent 40%);
            z-index: -1;
            pointer-events: none;
        }

        .glass { background: var(--card); backdrop-filter: blur(24px); border: 1px solid var(--border); }
        
        .btn-fast { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); cursor: pointer; }
        .btn-fast:active { transform: scale(0.95); }

        .card-anim { 
            opacity: 0; transform: translateY(20px);
            animation: fadeInUp 0.5s ease forwards;
            transition: all 0.3s ease; 
        }
        .card-anim:hover { 
            transform: translateY(-8px) !important; 
            border-color: var(--accent);
            box-shadow: 0 10px 40px -10px var(--accent-glow);
        }

        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        .modal { 
            display: none; position: fixed; inset: 0; 
            background: rgba(0,0,0,0.8); backdrop-filter: blur(15px); 
            z-index: 1000; align-items: center; justify-content: center; padding: 20px; 
        }
        .modal.active { display: flex; animation: modalShow 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }
        @keyframes modalShow { from{opacity:0; transform:scale(0.9)} to{opacity:1; transform:scale(1)} }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        input, textarea, select { 
            background: rgba(0,0,0,0.4) !important; border: 1px solid var(--border) !important; 
            color: white !important; outline: none; transition: 0.2s;
        }
        input:focus, select:focus { border-color: var(--accent) !important; }

        .av-box { background-size: cover; background-position: center; display: flex; align-items: center; justify-content: center; }
        
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 9999; }
        .toast {
            background: rgba(18, 20, 25, 0.95); border: 1px solid var(--border);
            border-left: 4px solid var(--accent); padding: 12px 20px; border-radius: 12px;
            margin-top: 10px; display: flex; align-items: center; gap: 12px;
            animation: toastIn 0.3s ease-out;
        }
        @keyframes toastIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body class="flex flex-col h-screen" data-theme="default">

<div class="bg-glow"></div>
<div id="toast-container"></div>

<nav class="glass mx-4 md:mx-10 mt-5 rounded-2xl px-6 py-3.5 flex justify-between items-center z-50">
    <div class="flex items-center gap-6">
        <div class="font-extrabold text-xl tracking-tighter flex items-center gap-2 cursor-pointer" onclick="location.reload()">
            <div class="w-9 h-9 rounded-xl flex items-center justify-center shadow-lg transition-colors" style="background: var(--accent);">
                <i data-lucide="zap" class="w-5 h-5 fill-white text-white"></i>
            </div>
            FLUX<span class="font-light opacity-40">HUB</span>
        </div>
        
        <select onchange="changeTheme(this.value)" class="glass text-[10px] px-2 py-1 rounded-lg opacity-50 hover:opacity-100 cursor-pointer">
            <option value="default">Midnight</option>
            <option value="violet">Neon Violet</option>
            <option value="emerald">Emerald</option>
        </select>
    </div>

    <div class="flex items-center gap-4">
        <div id="authBox">
            <button onclick="toggleModal('authModal')" class="bg-white text-black px-6 py-2 rounded-xl font-extrabold text-xs btn-fast">Connect</button>
        </div>
        <div id="userUI" class="hidden flex items-center gap-3">
            <div id="navAv" onclick="openProfile(USER)" class="w-10 h-10 rounded-xl glass av-box font-bold text-sm cursor-pointer border-2 border-white/5 hover:border-[var(--accent)] transition-all overflow-hidden"></div>
        </div>
    </div>
</nav>

<main class="flex-1 overflow-y-auto p-6 md:p-10 custom-scroll">
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between items-end mb-10 gap-6">
            <div class="space-y-1">
                <h1 class="text-5xl font-800 tracking-tighter">Scripts</h1>
                <p class="text-white/40 text-sm font-medium">Verified tools for the community.</p>
            </div>
            <div class="flex gap-3 w-full md:w-auto">
                <div class="relative flex-1 md:flex-none">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 opacity-30"></i>
                    <input id="search" oninput="doSearch()" placeholder="Search..." class="glass py-3 pl-12 pr-6 rounded-xl w-full md:w-64 text-sm" spellcheck="false">
                </div>
                <button onclick="checkAuthAndOpen('uploadModal')" class="px-6 py-3 rounded-xl font-bold text-[10px] uppercase tracking-wider btn-fast shadow-xl" style="background: var(--accent);">
                    + Upload
                </button>
            </div>
        </div>

        <div id="tagsCloud" class="flex flex-wrap gap-2 mb-8"></div>
        <div id="grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6"></div>
    </div>
</main>

<div id="profileModal" class="modal">
    <div class="glass w-full max-w-[340px] rounded-[2.5rem] overflow-hidden relative border-white/10 shadow-2xl">
        <div class="h-24 transition-colors" style="background: linear-gradient(to bottom right, var(--accent), transparent);"></div>
        <div class="p-6 pt-0 text-center -mt-12">
            <div id="pAvatar" class="w-24 h-24 rounded-[2rem] glass av-box mx-auto mb-4 border-4 border-[var(--bg)] shadow-2xl text-3xl font-bold transition-all"></div>
            <h2 id="pName" class="text-2xl font-800 tracking-tight">User</h2>
            <p id="pBio" class="text-white/40 text-xs mt-2 px-4 line-clamp-2 italic">No bio yet...</p>
            
            <div class="flex justify-center gap-4 mt-6">
                <div class="text-center">
                    <p id="pCount" class="text-lg font-bold">0</p>
                    <p class="text-[8px] uppercase tracking-widest opacity-30">Scripts</p>
                </div>
            </div>

            <div id="selfActions" class="hidden flex gap-2 mt-6">
                <button onclick="toggleEditMode()" class="flex-1 py-3 rounded-xl bg-white/5 text-[9px] font-black uppercase border border-white/5 btn-fast">Edit Profile</button>
                <button onclick="logout()" class="px-4 py-3 rounded-xl bg-red-500/10 text-red-500 border border-red-500/10 btn-fast"><i data-lucide="log-out" class="w-4 h-4"></i></button>
            </div>
            
            <div id="editArea" class="hidden space-y-2 mt-4 pt-4 border-t border-white/5">
                <input id="upAv" placeholder="Avatar URL" class="w-full p-3 rounded-xl text-[10px]">
                <textarea id="upBio" placeholder="Tell us about yourself..." class="w-full p-3 rounded-xl text-[10px] h-20 resize-none"></textarea>
                <button onclick="saveProfile()" class="w-full py-3 rounded-xl text-[9px] font-black uppercase btn-fast" style="background: var(--accent);">Save Profile</button>
            </div>
        </div>
        <button onclick="toggleModal('profileModal')" class="absolute top-5 right-5 opacity-30 hover:opacity-100 transition"><i data-lucide="x"></i></button>
    </div>
</div>

<div id="viewModal" class="modal" onclick="if(event.target==this)toggleModal('viewModal')">
    <div class="glass w-full max-w-[420px] rounded-[2.5rem] overflow-hidden relative">
        <div id="vImg" class="h-48 bg-cover bg-center relative">
            <div class="absolute inset-0 bg-gradient-to-t from-[var(--bg)] to-transparent"></div>
        </div>
        <div class="p-8 -mt-10 relative">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h2 id="vName" class="text-2xl font-800 tracking-tight text-white truncate max-w-[200px]">Title</h2>
                    <p id="vGame" class="text-[10px] font-black uppercase tracking-widest" style="color: var(--accent);">Game</p>
                </div>
                <div id="vAuthorAv" class="w-12 h-12 rounded-xl glass av-box font-bold border border-white/10 cursor-pointer hover:scale-110 transition"></div>
            </div>
            <div class="bg-black/40 rounded-2xl p-4 mb-6 border border-white/5">
                <pre id="vCode" class="text-[10px] font-mono text-white/60 h-32 overflow-y-auto custom-scroll italic break-all"></pre>
            </div>
            <button id="vCopyBtn" class="w-full bg-white text-black py-4 rounded-2xl font-black uppercase text-[10px] tracking-widest btn-fast">Copy Code</button>
            <div id="vActions" class="mt-2"></div>
        </div>
        <button onclick="toggleModal('viewModal')" class="absolute top-5 right-5 text-white/30 hover:text-white"><i data-lucide="x"></i></button>
    </div>
</div>

<div id="authModal" class="modal">
    <div class="glass p-10 rounded-[3rem] w-full max-w-sm text-center">
        <h2 class="text-2xl font-800 mb-6 tracking-tighter">Connection</h2>
        <div class="space-y-3">
            <input id="authUser" placeholder="Username" class="w-full p-4 rounded-2xl text-sm">
            <input id="authPass" type="password" placeholder="Password" class="w-full p-4 rounded-2xl mb-6 text-sm">
            <button onclick="handleAuth()" class="w-full bg-white text-black font-black py-4 rounded-2xl btn-fast uppercase text-[10px]">Establish Link</button>
        </div>
    </div>
</div>

<div id="uploadModal" class="modal">
    <div class="glass p-8 rounded-[2.5rem] w-full max-w-xl relative">
        <h2 class="text-2xl font-800 mb-6">Publish</h2>
        <div class="grid grid-cols-2 gap-4 mb-4">
            <input id="sName" placeholder="Name" class="p-4 rounded-xl text-sm">
            <input id="sGame" placeholder="Game" class="p-4 rounded-xl text-sm">
        </div>
        <textarea id="sCode" placeholder="Paste Lua code here..." class="w-full p-4 rounded-xl mb-6 h-48 font-mono text-[11px] custom-scroll"></textarea>
        <button onclick="sendScript()" class="w-full py-4 rounded-2xl font-black uppercase text-xs btn-fast" style="background: var(--accent);">Deploy Script</button>
        <button onclick="toggleModal('uploadModal')" class="absolute top-8 right-8 opacity-20 hover:opacity-100"><i data-lucide="x"></i></button>
    </div>
</div>

<script>
const API = "https://script.google.com/macros/s/AKfycbxBqAhdpBcLRDe9iMdyBVvps49xnkhmhgspxa1kby3cOCWkcb-1whoaAxB2mxouO78OZA/exec"; 
let USER = localStorage.getItem("flux_user");
let DB = { scripts: [], users: {}, games: [] };

window.onload = () => { 
    const savedTheme = localStorage.getItem("flux_theme") || "default";
    changeTheme(savedTheme);
    document.querySelector('select').value = savedTheme;
    lucide.createIcons(); 
    loadAll(); 
};

function changeTheme(theme) {
    document.body.setAttribute('data-theme', theme);
    localStorage.setItem("flux_theme", theme);
}

function showToast(text, icon = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = `<i data-lucide="${icon}" class="w-4 h-4" style="color:var(--accent)"></i><span class="text-[10px] font-bold uppercase tracking-widest">${text}</span>`;
    container.appendChild(toast);
    lucide.createIcons();
    setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 3000);
}

async function loadAll() {
    try {
        const r = await fetch(API);
        DB = await r.json();
        render();
        renderTags();
        if(USER) showUI();
    } catch (e) { showToast("Sync Error", "alert-triangle"); }
}

function render(filterGame = "", searchQ = "") {
    const grid = document.getElementById('grid');
    grid.innerHTML = "";
    let items = DB.scripts.slice().reverse();
    
    if(filterGame) items = items.filter(i => i.game === filterGame);
    if(searchQ) items = items.filter(i => i.name.toLowerCase().includes(searchQ.toLowerCase()));

    items.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = "glass p-4 rounded-[2rem] card-anim border-white/5";
        card.style.animationDelay = `${index * 0.05}s`;
        card.onclick = () => openView(item);
        card.innerHTML = `
            <div class="h-32 rounded-2xl bg-black/40 mb-4 overflow-hidden relative group">
                <img src="${item.img || ''}" class="w-full h-full object-cover opacity-60 group-hover:scale-110 transition-transform duration-700" onerror="this.src='https://api.dicebear.com/7.x/identicon/svg?seed=${item.name}'">
                <div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>
            </div>
            <h3 class="font-extrabold text-sm mb-1 truncate">${item.name}</h3>
            <p class="text-[9px] font-black uppercase tracking-widest opacity-80" style="color:var(--accent)">${item.game}</p>
            <div class="flex items-center gap-2 mt-4 opacity-40">
                <div class="w-5 h-5 rounded-lg glass av-box text-[8px] font-bold">${(item.author || '?')[0]}</div>
                <span class="text-[10px] font-bold">${item.author}</span>
            </div>`;
        grid.appendChild(card);
    });
    lucide.createIcons();
}

function openView(item) {
    document.getElementById('vName').innerText = item.name;
    document.getElementById('vGame').innerText = item.game;
    document.getElementById('vImg').style.backgroundImage = `url('${item.img || ''}')`;
    document.getElementById('vCode').textContent = item.code || "-- No Code --";
    
    setAvatar(document.getElementById('vAuthorAv'), (DB.users[item.author] || {}).avatar, item.author);
    document.getElementById('vAuthorAv').onclick = (e) => { e.stopPropagation(); openProfile(item.author); };

    const actions = document.getElementById('vActions');
    actions.innerHTML = "";
    if(USER && item.author === USER) {
        const del = document.createElement('button');
        del.className = "w-full mt-2 py-3 text-red-500 text-[9px] font-bold uppercase opacity-50 hover:opacity-100 transition";
        del.innerText = "Delete Script";
        del.onclick = () => deleteScript(item.name);
        actions.appendChild(del);
    }

    document.getElementById('vCopyBtn').onclick = () => {
        navigator.clipboard.writeText(item.code);
        showToast("Code Copied", "check");
    };
    toggleModal('viewModal');
}

function openProfile(name) {
    const u = DB.users[name] || {};
    document.getElementById('pName').innerText = name;
    document.getElementById('pBio').innerText = u.bio || "This user prefers to keep a mystery...";
    setAvatar(document.getElementById('pAvatar'), u.avatar, name);
    
    const count = DB.scripts.filter(s => s.author === name).length;
    document.getElementById('pCount').innerText = count;

    document.getElementById('selfActions').classList.toggle('hidden', name !== USER);
    document.getElementById('editArea').classList.add('hidden');
    
    if(name === USER) {
        document.getElementById('upAv').value = u.avatar || "";
        document.getElementById('upBio').value = u.bio || "";
    }
    
    toggleModal('profileModal');
}

async function saveProfile() {
    const avatar = document.getElementById('upAv').value;
    const bio = document.getElementById('upBio').value;
    showToast("Updating Link...", "loader");
    await fetch(API, { method: "POST", body: JSON.stringify({ action: "updateProfile", user: USER, avatar: avatar, bio: bio }) });
    location.reload();
}

async function handleAuth() {
    const user = document.getElementById('authUser').value.trim();
    const pass = document.getElementById('authPass').value.trim();
    const res = await fetch(API, { method: "POST", body: JSON.stringify({ action: "auth", username: user, password: pass }) }).then(r => r.json());
    if(res.status === "success") { localStorage.setItem("flux_user", res.user); location.reload(); }
    else showToast(res.msg, "x-circle");
}

function setAvatar(el, url, name) {
    if(url && url.startsWith('http')) { el.style.backgroundImage = `url('${url}')`; el.innerHTML = ""; }
    else { el.style.backgroundImage = "none"; el.innerHTML = name ? name[0].toUpperCase() : "?"; }
}

async function sendScript() {
    const data = { action: "upload", name: document.getElementById('sName').value, game: document.getElementById('sGame').value, code: document.getElementById('sCode').value, author: USER };
    await fetch(API, { method: "POST", body: JSON.stringify(data) });
    location.reload();
}

async function deleteScript(name) {
    if(!confirm("Destroy this script?")) return;
    await fetch(API, { method: "POST", body: JSON.stringify({ action: "delete", name: name, author: USER }) });
    location.reload();
}

function renderTags() {
    const cloud = document.getElementById('tagsCloud');
    cloud.innerHTML = `<button onclick="render('')" class="px-4 py-2 rounded-xl glass text-[9px] font-black uppercase opacity-40 hover:opacity-100 transition"># All</button>`;
    [...new Set(DB.games)].filter(g => g).forEach(game => {
        cloud.innerHTML += `<button onclick="render('${game}')" class="px-4 py-2 rounded-xl glass text-[9px] font-black uppercase opacity-40 hover:opacity-100 transition"># ${game}</button>`;
    });
}

function showUI() {
    document.getElementById('authBox').classList.add('hidden');
    document.getElementById('userUI').classList.remove('hidden');
    setAvatar(document.getElementById('navAv'), (DB.users[USER] || {}).avatar, USER);
}

function doSearch() { render("", document.getElementById('search').value); }
function toggleModal(id) { document.getElementById(id).classList.toggle('active'); }
function logout() { localStorage.clear(); location.reload(); }
function toggleEditMode() { document.getElementById('editArea').classList.toggle('hidden'); }
function checkAuthAndOpen(id) { if(!USER) toggleModal('authModal'); else toggleModal(id); }
</script>
</body>
</html>
